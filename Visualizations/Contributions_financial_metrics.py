import matplotlib.pyplot as plt
import matplotlib.colors as mc
import colorsys
from matplotlib.gridspec import GridSpec

# --- 1. DEFINE METRICS AND EXTRACT DATA ---
metrics = [
    "Profits in BUYs",
    "Losses in BUYs", 
    "Profits in SELLs",
    "Losses in SELLs",
    "Average return",
    "Maximum drawdown",
    "Downside dev",
    "Sortino ratio",
    "Calmar ratio"
]

# All data extracted from your table
profits_buys = {
    "without_fusing_first": [6.5186, 4.6469, 5.2738, 7.7719, 4.5806, 4.2919, 3.7304, 9.086, 11.7337, 3.1238, 4.9873, 5.9777, 8.5117, 4.1724, 5.1234, 5.9155, 5.2279, 2.4469, 4.8198, 5.8146, 6.3519, 8.6741, 4.4609, 6.5751, 10.8223, 6.0877, 6.4201, 5.9016, 7.7429, 3.8948],
    "without_fusing_second": [7.1326, 7.8380, 7.8658, 7.6036, 6.6606, 7.7481, 7.7865, 9.3043, 8.6221, 5.2362, 6.2829, 9.3641, 8.3384, 5.7422, 10.3936, 8.1681, 7.9854, 3.3744, 7.0475, 8.2195, 7.2309, 7.7573, 6.4587, 4.9230, 8.8755, 5.7777, 10.6693, 7.4708, 8.7960, 8.5179],
    "fusing_tpl_first": [8.0451, 6.8553, 6.6048, 9.7005, 9.8468, 6.235, 5.9146, 13.6139, 13.2501, 12.4305, 7.1726, 10.2122, 13.1222, 6.763, 8.8251, 10.8499, 8.2079, 6.7445, 7.9526, 10.5001, 9.2216, 13.8219, 6.8, 8.2259, 14.498, 8.539, 13.1015, 7.8671, 9.0364, 7.4162],
    "fusing_tpl_second": [8.2302, 8.3181, 7.0985, 10.3408, 10.5974, 8.0495, 6.8124, 14.5041, 13.1603, 12.9627, 9.3067, 11.4477, 9.8380, 7.6037, 9.9519, 10.0724, 8.7624, 7.2284, 8.3653, 9.1402, 9.2333, 13.0548, 7.5276, 7.7035, 13.6278, 7.4574, 13.4156, 8.5195, 9.2630, 7.4840],
    "fusing_tpl_msfe_first": [6.8169, 7.7313, 7.496, 10.4725, 9.1395, 7.9654, 7.3916, 14.69, 14.2968, 14.0550, 9.8806, 11.0324, 10.5235, 7.1054, 9.0772, 9.1632, 7.4457, 7.2565, 8.6926, 9.2672, 8.9806, 12.2356, 7.9308, 7.0353, 12.2466, 7.9194, 13.4363, 8.328, 8.0568, 7.7452],
    "fusing_tpl_msfe_second": [7.4077, 7.9432, 7.3867, 9.3523, 8.8774, 7.6887, 7.1954, 16.9160, 13.6957, 12.1118, 9.9699, 11.5362, 10.1393, 8.1268, 10.1168, 9.9486, 8.2677, 6.7983, 8.4480, 9.5506, 8.8545, 12.8100, 8.5621, 7.6860, 11.9077, 7.5237, 14.3656, 8.0815, 9.1362, 7.8506]
}

losses_buys = {
    "without_fusing_first": [-5.3588, -5.1475, -5.6765, -8.8907, -4.4731, -5.5224, -4.1431, -9.5431, -12.468, -3.1154, -5.5252, -7.085, -9.4308, -4.5976, -6.3757, -6.6808, -6.4177, -3.3393, -5.499, -6.161, -5.2967, -8.3894, -4.9391, -5.9762, -10.9167, -6.0717, -6.059, -8.2009, -7.065, -4.9719],
    "without_fusing_second": [-6.6477, -8.6151, -8.5140, -8.8848, -6.4086, -7.3559, -6.7951, -8.7122, -9.8061, -5.4886, -7.3532, -10.4986, -8.8335, -6.6805, -10.4231, -8.4701, -8.5932, -4.6622, -7.3646, -8.9340, -8.2471, -7.3615, -5.1240, -3.8241, -9.3094, -5.3475, -8.7411, -8.7460, -7.9739, -8.2688],
    "fusing_tpl_first": [-1.9667, -3.4091, -2.9923, -2.3337, -3.2381, -0.8788, -1.1779, -2.0934, -3.606, -2.3971, -1.613, -2.5368, -3.5843, -1.5758, -1.907, -3.1665, -2.234, -1.5688, -1.372, -1.4536, -1.9467, -3.4582, -1.3361, -2.0522, -3.7735, -2.6076, -2.8831, -1.3695, -1.6636, -1.6505],
    "fusing_tpl_second": [-2.0039, -1.6737, -1.6743, -2.1510, -6.1735, -1.5699, -2.7672, -2.6440, -2.9603, -2.6995, -2.0546, -2.5654, -1.6797, -1.8387, -2.2022, -2.3622, -2.4406, -1.0060, -1.4201, -1.7580, -2.2556, -3.3379, -1.7223, -1.2805, -3.1176, -1.8887, -2.6790, -1.9616, -1.7452, -1.9713],
    "fusing_tpl_msfe_first": [-1.8996, -1.86, -1.9965, -2.4887, -2.1437, -1.7619, -1.3175, -1.8637, -2.809, -2.8288, -2.2716, -1.6695, -2.1443, -1.0551, -1.3929, -1.4016, -1.2535, -1.0115, -1.3705, -1.4133, -1.7149, -2.3636, -1.599, -0.745, -1.7339, -1.1654, -1.4254, -1.2519, -1.0571, -1.5639],
    "fusing_tpl_msfe_second": [-1.4418, -1.5076, -1.2452, -1.6525, -1.7174, -1.2367, -1.6347, -2.6980, -2.3528, -1.9192, -2.1212, -2.0985, -1.8398, -2.0437, -1.8123, -1.4377, -1.6617, -1.3626, -1.7768, -1.5656, -1.7757, -2.3887, -1.9194, -1.0442, -1.9154, -1.5015, -2.6089, -1.3012, -1.9569, -1.6283]
}

profits_sells = {
    "without_fusing_first": [2.9328, 3.0055, 2.41, 3.9372, 4.1807, 3.9086, 4.0002, 7.6511, 4.8901, 6.9370, 3.965, 5.0209, 4.8182, 3.8179, 5.4032, 6.7206, 3.1364, 6.0485, 3.7233, 4.9353, 3.035, 5.1901, 3.3519, 5.5241, 5.241, 2.9797, 9.4202, 2.7417, 3.464, 4.6711],
    "without_fusing_second": [3.2898, 1.9144, 1.2306, 4.3715, 3.1651, 2.6627, 2.2519, 8.7245, 6.9827, 4.242, 2.8193, 2.0866, 6.4507, 2.5686, 2.2237, 5.2754, 1.7329, 5.6282, 2.0106, 3.9614, 1.8572, 7.7192, 3.2384, 7.9923, 6.3412, 3.8535, 7.7529, 2.6504, 3.8484, 2.3018],
    "fusing_tpl_first": [8.9948, 7.7033, 8.3453, 11.2328, 6.17, 10.8644, 9.318, 18.618, 15.5636, 15.7888, 9.7721, 11.1428, 12.3392, 8.6548, 10.7584, 11.3392, 8.1906, 10.4387, 8.9319, 10.8757, 8.6714, 12.4898, 9.0123, 11.5866, 13.8057, 8.062, 14.4576, 9.9518, 11.1543, 9.8592],
    "fusing_tpl_second": [8.8894, 8.3341, 7.7084, 10.6595, 6.6795, 9.3045, 8.1427, 17.3547, 16.1312, 14.9597, 9.0245, 10.4213, 14.6114, 7.4186, 10.1254, 12.3706, 7.9611, 10.3976, 8.8836, 12.0706, 8.1183, 12.6485, 8.4178, 12.4193, 14.9078, 8.6513, 13.9756, 9.2346, 10.9029, 8.8691],
    "fusing_tpl_msfe_first": [10.2935, 9.1654, 7.6413, 11.5043, 8.2871, 9.7998, 8.6081, 18.8981, 15.8415, 14.9392, 8.8023, 12.0128, 15.2538, 8.5139, 11.5941, 14.1475, 9.5008, 10.8811, 8.5444, 12.5761, 8.827, 14.6287, 8.4921, 13.3943, 17.7491, 9.9315, 14.9594, 10.4991, 12.2858, 9.5407],
    "fusing_tpl_msfe_second": [9.8137, 8.9538, 7.9206, 11.6232, 8.2391, 9.9751, 8.5135, 15.9306, 16.7342, 17.4697, 8.8017, 11.3927, 14.3447, 7.3661, 10.5457, 13.6401, 8.6111, 10.1726, 8.8824, 12.2564, 8.9827, 13.9840, 7.7954, 12.9693, 17.5578, 9.7779, 13.9450, 10.3828, 10.3306, 9.3747]
}

losses_sells = {
    "without_fusing_first": [-6.9308, -8.2845, -5.8987, -6.6467, -7.2361, -7.9186, -8.6975, -10.6492, -8.4245, -9.0426, -8.764, -9.5726, -9.0036, -7.5495, -8.5156, -9.5297, -6.191, -10.7151, -7.0448, -8.7553, -7.0697, -8.2541, -7.9464, -7.6065, -9.2261, -6.2981, -11.5101, -6.5103, -6.9058, -8.0214],
    "without_fusing_second": [-5.8234, -3.7167, -2.8013, -6.3276, -5.3751, -4.6214, -4.3833, -10.7535, -10.5902, -7.1420, -6.6819, -5.4962, -8.7517, -5.0881, -3.5543, -7.4406, -3.7592, -8.4946, -4.9070, -6.1051, -4.6555, -10.0924, -5.3532, -8.6025, -10.8398, -7.1565, -7.8800, -5.3839, -5.4457, -4.1015],
    "fusing_tpl_first": [-4.2278, -5.469, -5.3343, -5.395, -3.6124, -4.9625, -5.1161, -6.8017, -7.1579, -8.0802, -6.6396, -5.2712, -4.8161, -4.2157, -5.0863, -5.1569, -4.3697, -4.5004, -4.535, -4.6335, -3.7909, -4.4141, -4.9134, -6.0723, -5.6442, -3.9299, -6.5597, -5.3018, -5.1787, -4.2672],
    "fusing_tpl_second": [-4.6589, -4.6394, -3.9059, -5.8941, -4.9988, -4.6349, -5.7978, -6.6765, -7.2703, -7.5920, -4.6556, -4.8890, -7.8958, -4.4795, -5.1254, -6.3497, -4.2663, -5.0573, -4.5289, -5.5665, -4.2129, -5.5400, -4.4253, -6.3385, -7.1720, -5.3175, -6.6372, -4.9878, -5.6910, -5.1000],
    "fusing_tpl_msfe_first": [-3.8488, -3.527, -3.0137, -3.7455, -2.4772, -3.4228, -3.8693, -5.1258, -6.5431, -5.1608, -3.1234, -4.4793, -6.1355, -3.7902, -4.3441, -5.5169, -4.0764, -3.5973, -3.7805, -4.5528, -3.7776, -4.3995, -3.2026, -6.4705, -6.5094, -3.5616, -5.9985, -4.3007, -5.5884, -4.2265],
    "fusing_tpl_msfe_second": [-4.3450, -4.5332, -3.3290, -5.5723, -4.0393, -4.0906, -3.9374, -5.3285, -6.1031, -5.4741, -3.4855, -3.9799, -7.9253, -3.5498, -4.6431, -5.5880, -3.6217, -5.1093, -3.6011, -4.2544, -3.7459, -4.4044, -3.6534, -5.5042, -6.4265, -4.1028, -5.4626, -4.2785, -5.4558, -4.4512]
}

average_return = {
    "without_fusing_first": [-0.3684, -0.5819, -0.4493, -0.4713, -0.3714, -0.5507, -0.5384, -0.4613, -0.543, -0.2920, -0.5592, -0.5904, -0.8508, -0.4727, -0.495, -0.4491, -0.4794, -0.5673, -0.4612, -0.4833, -0.3801, -0.3905, -0.5354, -0.2394, -0.5133, -0.4035, -0.3024, -0.6011, -0.3685, -0.4952],
    "without_fusing_second": [-0.2958, -0.3410, -0.3000, -0.4870, -0.2756, -0.2425, -0.1876, -0.2830, -0.5708, -0.3905, -0.5316, -0.5148, -0.4061, -0.4165, -0.2232, -0.3562, -0.3552, -0.4727, -0.3960, -0.3825, -0.4526, -0.3267, -0.1397, 0.6549, -0.5659, -0.3689, 0.1364, -0.4647, -0.1603, -0.2437],
    "fusing_tpl_first": [3.4531, 1.1297, 1.4381, 5.0298, 2.5301, 3.733, 2.432, 23.2047, 10.0118, 10.0236, 2.2556, 5.3782, 9.0237, 2.7745, 4.6862, 5.6448, 2.8357, 3.6826, 3.5652, 6.166, 4.3461, 11.4545, 2.7511, 3.962, 12.0586, 3.0124, 10.7926, 3.6595, 5.3088, 3.7992],
    "fusing_tpl_second": [3.1940, 3.1777, 2.5918, 4.8177, 1.1936, 3.6481, 1.3517, 20.7142, 11.8065, 9.9038, 3.9522, 6.2038, 6.3050, 2.3086, 4.8114, 5.5028, 2.9549, 3.9648, 3.7791, 5.7426, 3.4676, 8.8469, 2.8830, 4.5714, 10.7724, 2.3984, 10.8170, 3.4262, 4.7398, 2.5713],
    "fusing_tpl_msfe_first": [3.7991, 3.9287, 3.091, 7.709, 4.9665, 4.7351, 3.4725, 37.7701, 15.3368, 16.8749, 5.3394, 9.2802, 9.6414, 3.4582, 6.9731, 8.5292, 3.9764, 5.5976, 4.3542, 7.9858, 4.4854, 14.8411, 4.0542, 5.1604, 18.5706, 5.2128, 16.9178, 5.2981, 5.5997, 3.8948],
    "fusing_tpl_msfe_second": [3.8306, 3.4828, 3.4672, 5.5201, 3.8336, 4.5183, 3.0593, 28.9776, 18.5197, 19.9416, 5.1895, 9.2240, 6.1576, 2.9283, 6.1799, 8.748, 3.9609, 3.2685, 4.2562, 8.1341, 4.4813, 14.5563, 3.4695, 6.0027, 16.9811, 4.0647, 15.0741, 4.9722, 4.2327, 3.6490]
}

maximum_drawdown = {
    "without_fusing_first": [-0.6765, -0.7659, -0.6636, -0.8373, -0.5927, -0.7365, -0.7935, -0.8629, -0.8936, -0.6025, -0.7882, -0.967, -0.8843, -0.7401, -0.7961, -0.7309, -0.7373, -0.7609, -0.6935, -0.7347, -0.72, -0.7586, -0.7915, -0.5533, -0.8522, -0.7116, -0.6721, -0.7936, -0.7913, -0.8104],
    "without_fusing_second": [-0.7386, -0.6913, -0.6586, -0.8691, -0.6587, -0.5568, -0.5566, -0.7806, -0.9326, -0.7149, -0.8513, -0.8047, -0.8629, -0.7694, -0.6677, -0.7437, -0.6972, -0.7257, -0.7235, -0.6898, -0.7945, -0.7570, -0.4961, -0.5359, -0.9060, -0.7003, -0.5999, -0.7122, -0.7345, -0.7395],
    "fusing_tpl_first": [-0.1102, -0.2727, -0.2563, -0.2684, -0.2577, -0.1798, -0.1312, -0.3071, -0.3973, -0.2536, -0.4643, -0.247, -0.2865, -0.1024, -0.1019, -0.1969, -0.1486, -0.1517, -0.1977, -0.1101, -0.0869, -0.1367, -0.1758, -0.2724, -0.1511, -0.1148, -0.1534, -0.1722, -0.1651, -0.0993],
    "fusing_tpl_second": [-0.1243, -0.098, -0.1562, -0.1264, -0.3463, -0.1779, -0.2252, -0.1390, -0.2602, -0.2536, -0.1341, -0.1504, -0.4119, -0.1251, -0.1019, -0.1761, -0.1486, -0.1517, -0.1977, -0.1275, -0.1146, -0.1367, -0.1758, -0.1037, -0.3008, -0.1149, -0.1051, -0.0957, -0.1046, -0.1195],
    "fusing_tpl_msfe_first": [-0.1102, -0.178, -0.1562, -0.165, -0.0786, -0.1178, -0.1312, -0.1548, -0.2817, -0.1382, -0.0905, -0.1351, -0.2054, -0.0802, -0.102, -0.1761, -0.1427, -0.0564, -0.224, -0.2325, -0.0797, -0.1596, -0.0759, -0.1363, -0.1967, -0.0845, -0.1149, -0.0824, -0.1129, -0.1085],
    "fusing_tpl_msfe_second": [-0.1285, -0.1298, -0.065, -0.2419, -0.0822, -0.1178, -0.1312, -0.1160, -0.2817, -0.2536, -0.1035, -0.1351, -0.2674, -0.1024, -0.102, -0.1761, -0.1427, -0.2193, -0.1145, -0.1101, -0.0984, -0.1729, -0.1758, -0.0974, -0.1967, -0.1148, -0.1679, -0.1701, -0.1619, -0.0993]
}

downside_dev = {
    "without_fusing_first": [0.2179, 0.2068, 0.1806, 0.2777, 0.1881, 0.2041, 0.2057, 0.3226, 0.3821, 0.1950, 0.236, 0.2962, 0.3564, 0.209, 0.2232, 0.2787, 0.1906, 0.2148, 0.2003, 0.2379, 0.2289, 0.2854, 0.1918, 0.2216, 0.3339, 0.1897, 0.2893, 0.224, 0.228, 0.1985],
mitigation_legend_elements = [
    plt.Line2D([0], [0], marker='s', color='w', 
               markerfacecolor=light_shade, 
               markersize=15, markeredgecolor='black', linewidth=1,
               label='Before Overfitting Mitigation'),
    plt.Line2D([0], [0], marker='s', color='w', 
               markerfacecolor=dark_shade, 
               markersize=15, markeredgecolor='black', linewidth=1,
               label='After Overfitting Mitigation')
]

# --- 4. CREATE PLOT WITH SYMLOG SCALE FOR SPECIFIC METRICS ---
fig = plt.figure(figsize=(15, 10))
gs = GridSpec(3, 3, figure=fig, hspace=0.1, wspace=0.3, bottom=0.05)

axes = []
for i in range(9):
    row = i // 3
    col = i % 3
    ax = fig.add_subplot(gs[row, col])
    axes.append(ax)

# Define which metrics should use symlog scale
symlog_metrics = ["Average return", "Sortino ratio", "Calmar ratio"]

# Plot each metric
for idx, metric_name in enumerate(metrics):
    ax = axes[idx]
    
    if metric_name in all_metrics_data:
        df_summary = process_metric_data(all_metrics_data[metric_name])
        
        bar_width = 0.2
        group_spacing = 0.8
        current_pos = 0
        
        for i, method in enumerate(methods):
            for j, mitigation in enumerate(mitigations):
                pos = current_pos + j * bar_width
                
                data = df_summary[(df_summary['Method'] == method) & 
                                  (df_summary['Mitigation'] == mitigation)].iloc[0]
                mean_val = data['mean']
                min_val = data['min']
                max_val = data['max']
                
                error = [[mean_val - min_val], [max_val - mean_val]]
                color = palette[(method, mitigation)]
                
                ax.bar(pos, mean_val, width=bar_width, color=color, edgecolor='black', zorder=2)
                ax.errorbar(pos, mean_val, yerr=error, fmt='none', c='black', 
                           capsize=6, elinewidth=1.5, zorder=3)
            
            current_pos += group_spacing
        
        ax.set_ylabel(metric_name, fontsize=16, labelpad=10)
        ax.tick_params(axis='y', labelsize=12)
        ax.set_xticks([])
        ax.set_xticklabels([])
        ax.tick_params(axis='x', length=0)
        
        # Apply symlog scale only to specific metrics
        if metric_name in symlog_metrics:
            ax.set_yscale('symlog', linthresh=1.5)
            # Set appropriate y-limits for symlog scale
            y_min = min(df_summary['min']) * 1.1
            y_max = max(df_summary['max']) * 1.1
            ax.set_ylim(y_min, y_max)
        else:
            # Regular y-limits for other metrics
            y_min = min(df_summary['min']) * 1.1
            y_max = max(df_summary['max']) * 1.1
            ax.set_ylim(y_min, y_max)
        
        ax.grid(True, axis='y', linestyle='-', alpha=0.5, zorder=1)
        ax.set_axisbelow(True)

# Create two separate legends side by side at the bottom
legend1 = fig.legend(handles=method_legend_elements,
                     loc='lower center',
                     bbox_to_anchor=(0.35, -0.15),  # Left side
                     ncol=1,
                     fontsize=20,
                     frameon=True,
                     framealpha=0.9,
                     edgecolor='black',
                     title='',
                     title_fontsize=25)

legend2 = fig.legend(handles=mitigation_legend_elements,
                     loc='lower center',
                     bbox_to_anchor=(0.7, -0.12),  # Right side
                     ncol=1,
                     fontsize=20,
                     frameon=True,
                     framealpha=0.9,
                     edgecolor='black',
                     title='',
                     title_fontsize=20)

fig.add_artist(legend1)
fig.add_artist(legend2)
plt.show()
